def handle_sprint_initiatives(chat_id):
    """Mostrar iniciativas en sprint (desarrollo)"""
    logger.info(f"üì± Sprint initiatives from chat {chat_id}")
    
    send_telegram_message(chat_id, "‚ö° **Cargando iniciativas en desarrollo...**")
    
    from database import get_sprint_initiatives
    data = get_sprint_initiatives()
    
    if not data.get("success"):
        send_telegram_message(chat_id, f"‚ùå Error: {data.get('error', 'Desconocido')}")
        return
    
    initiatives = data.get("data", [])
    
    if not initiatives:
        send_telegram_message(chat_id, "üîß **No hay iniciativas en desarrollo actualmente.**\n\nüí° Las iniciativas en sprint son las que el equipo de tecnolog√≠a est√° trabajando.")
        return
    
    text = f"üîß **INICIATIVAS EN DESARROLLO** ({len(initiatives)} activas)\n\n"
    text += "‚ö° **Equipo Tech trabajando en:**\n\n"
    
    for i, init in enumerate(initiatives[:MAX_RESULTS_LIST], 1):
        formatted = format_initiative_summary_fast(init, i)
        # Agregar info espec√≠fica de sprint
        status = init.get('status', 'In Sprint')
        text += f"{formatted}\nüîß Estado: {status}\n\n"
    
    if len(initiatives) > MAX_RESULTS_LIST:
        text += f"üìå **{len(initiatives) - MAX_RESULTS_LIST} iniciativas m√°s en desarrollo...**"
    
    text += f"\nüí° **Tip:** Estas son las iniciativas que est√°n siendo desarrolladas por el equipo t√©cnico."
    
    send_telegram_message(chat_id, text, parse_mode='Markdown')

def handle_production_initiatives(chat_id):
    """Mostrar iniciativas en producci√≥n/monitoreo"""
    logger.info(f"üì± Production initiatives from chat {chat_id}")
    
    send_telegram_message(chat_id, "‚ö° **Cargando iniciativas implementadas...**")
    
    from database import get_production_initiatives
    data = get_production_initiatives()
    
    if not data.get("success"):
        send_telegram_message(chat_id, f"‚ùå Error: {data.get('error', 'Desconocido')}")
        return
    
    initiatives = data.get("data", [])
    
    if not initiatives:
        send_telegram_message(chat_id, "üöÄ **No hay iniciativas implementadas actualmente.**\n\nüí° Aqu√≠ aparecer√°n las iniciativas que ya est√°n en producci√≥n o siendo monitoreadas.")
        return
    
    # Separar por estado
    production = [i for i in initiatives if i.get('status') == 'Production']
    monitoring = [i for i in initiatives if i.get('status') == 'Monitoring']
    
    text = f"üöÄ **INICIATIVAS IMPLEMENTADAS** ({len(initiatives)} totales)\n\n"
    
    if production:
        text += f"‚úÖ **EN PRODUCCI√ìN** ({len(production)}):\n"
        for i, init in enumerate(production[:5], 1):
            formatted = format_initiative_summary_fast(init, i)
            text += f"{formatted}\nüöÄ Estado: Production\n\n"
    
    if monitoring:
        text += f"üìä **EN MONITOREO** ({len(monitoring)}):\n"
        for i, init in enumerate(monitoring[:5], 1):
            formatted = format_initiative_summary_fast(init, i)
            text += f"{formatted}\nüìä Estado: Monitoring\n\n"
    
    if len(initiatives) > 10:
        text += f"üìå **{len(initiatives) - 10} iniciativas m√°s implementadas...**\n"
    
    text += f"\nüí° **Tip:** Estas iniciativas ya est√°n disponibles para usuarios o siendo monitoreadas."
    
    send_telegram_message(chat_id, text, parse_mode='Markdown')

def handle_status_info(chat_id):
    """Mostrar informaci√≥n sobre comandos de estado"""
    text = """üìä **Comandos de Estado Disponibles** 

**üîÑ Filtros R√°pidos:**
‚Ä¢ pending - Ver iniciativas pendientes
‚Ä¢ sprint - Ver las en desarrollo activo
‚Ä¢ production - Ver las implementadas
‚Ä¢ monitoring - Ver las en monitoreo
‚Ä¢ cancelled - Ver las canceladas
‚Ä¢ hold - Ver las pausadas

**üìà Estados del Flujo:**
‚è≥ Pending - Pendiente de iniciar
üîß Sprint - En desarrollo activo
üöÄ Production - Implementada y activa
üìä Monitoring - En monitoreo post-implementaci√≥n
‚ùå Cancelled - Cancelada
‚è∏Ô∏è Hold - Pausada temporalmente

**üìã Flujo T√≠pico:**
Pending ‚Üí Sprint ‚Üí Production ‚Üí Monitoring

**üí° Ejemplos de uso:**
‚Ä¢ Escribe: pending
‚Ä¢ Escribe: sprint
‚Ä¢ Escribe: production

**üîç Para b√∫squedas espec√≠ficas:**
‚Ä¢ buscar Product sprint - Buscar en equipo + estado
‚Ä¢ buscar API production - Buscar implementadas

**Tip:** Solo escribe la palabra del estado, sin s√≠mbolos ni comillas."""
    
    send_telegram_message(chat_id, text, parse_mode='Markdown')

def handle_filter_by_status(chat_id, status):
    """Filtrar iniciativas por estado espec√≠fico - SIMPLIFICADO"""
    logger.info(f"üì± Filter by status '{status}' from chat {chat_id}")
    
    # Mapear comandos simples a filtros predefinidos
    status_mapping = {
        'pending': 'pending',
        'sprint': 'sprint', 
        'production': 'production',
        'monitoring': 'monitoring',
        'cancelled': 'cancelled',
        'hold': 'hold'
    }
    
    filter_key = status_mapping.get(status.lower())
    
    if not filter_key:
        send_telegram_message(chat_id, f"""‚ùå **Estado inv√°lido:** {status}

**Comandos v√°lidos:**
‚Ä¢ pending - Ver pendientes
‚Ä¢ sprint - Ver en desarrollo
‚Ä¢ production - Ver implementadas
‚Ä¢ monitoring - Ver en monitoreo
‚Ä¢ cancelled - Ver canceladas
‚Ä¢ hold - Ver pausadas

**Ejemplo:** Escribe solo: pending""", parse_mode='Markdown')
        return
    
    send_telegram_message(chat_id, f"‚ö° **Filtrando por: {status}...**")
    
    from database import get_initiatives_by_status
    status_list = STATUS_FILTERS[filter_key]
    data = get_initiatives_by_status(status_list)
    
    if not data.get("success"):
        send_telegram_message(chat_id, f"‚ùå Error: {data.get('error', 'Desconocido')}")
        return
    
    initiatives = data.get("data", [])
    
    if not initiatives:
        send_telegram_message(chat_id, f"üì≠ **No hay iniciativas con estado '{status}'**\n\nüí° Prueba con otro estado o escribe: estados")
        return
    
    # Emoji para cada estado
    status_emojis = {
        'pending': '‚è≥',
        'sprint': 'üîß',
        'production': 'üöÄ',
        'monitoring': 'üìä',
        'cancelled': '‚ùå',
        'hold': '‚è∏Ô∏è'
    }
    
    emoji = status_emojis.get(status.lower(), 'üìã')
    
    text = f"{emoji} **INICIATIVAS - {status.upper()}** ({len(initiatives)} encontradas)\n\n"
    
    for i, init in enumerate(initiatives[:MAX_RESULTS_LIST], 1):
        formatted = format_initiative_summary_fast(init, i)
        text += f"{formatted}\n{emoji} Estado: {init.get('status', 'N/A')}\n\n"
    
    if len(initiatives) > MAX_RESULTS_LIST:
        text += f"üìå **{len(initiatives) - MAX_RESULTS_LIST} iniciativas m√°s con este estado...**\n"
    
    text += f"\nüí° **Tip:** Escribe buscar para encontrar iniciativas espec√≠ficas en este estado."
    
    send_telegram_message(chat_id, text, parse_mode='Markdown')# ü§ñ bot_handlers.py - Manejadores del Bot v2.5
import logging
from flask import request
from config import *
from database import get_initiatives, search_initiatives, create_initiative, calculate_score_fast
from analytics import calculate_statistics_fast, format_statistics_text_fast, analyze_initiatives_with_llm_fast
from utils import send_telegram_message

logger = logging.getLogger(__name__)

# Variables globales para estados de usuario
user_states = {}

def setup_telegram_routes(app):
    """Configurar rutas del bot de Telegram"""
    
    @app.route('/telegram-webhook', methods=['POST'])
    def telegram_webhook():
        """Webhook optimizado"""
        try:
            update_data = request.get_json()
            
            if not update_data or 'message' not in update_data:
                return "OK", 200
            
            message = update_data['message']
            chat_id = message['chat']['id']
            user_id = message['from']['id']
            
            if 'text' not in message:
                return "OK", 200
            
            text = message['text'].strip().lower()
            
            # Router optimizado
            if text in ['/start', 'start', 'inicio', 'hola']:
                handle_start_command(chat_id)
            elif text in ['/help', 'help', 'ayuda']:
                handle_help_command(chat_id)
            elif text in ['/iniciativas', 'iniciativas', 'lista']:
                handle_list_initiatives_fast(chat_id)
            elif text in ['/crear', 'crear', 'nueva']:
                handle_create_command(chat_id, user_id)
            elif text in ['/analizar', 'analizar', 'an√°lisis']:
                handle_analyze_command_fast(chat_id)
            elif text.startswith(('buscar ', '/buscar ')):
                query = text.split(' ', 1)[1] if ' ' in text else ""
                if query:
                    handle_search_command_fast(chat_id, query)
                else:
                    send_telegram_message(chat_id, "üîç **¬øQu√© quieres buscar?**\n\nEjemplos:\n‚Ä¢ `buscar Product`\n‚Ä¢ `buscar API`")
            elif text in ['/sprint', 'sprint', 'desarrollo', 'dev']:
                handle_sprint_initiatives(chat_id)
            elif text in ['/production', 'production', 'produccion', 'prod']:
                handle_production_initiatives(chat_id)
            elif text in ['/pending', 'pending', 'pendiente']:
                handle_filter_by_status(chat_id, 'pending')
            elif text in ['/monitoring', 'monitoring', 'monitoreo']:
                handle_filter_by_status(chat_id, 'monitoring')
            elif text in ['/cancelled', 'cancelled', 'canceladas']:
                handle_filter_by_status(chat_id, 'cancelled')
            elif text in ['/hold', 'hold', 'pausa', 'pausadas']:
                handle_filter_by_status(chat_id, 'hold')
            elif text in ['/estados', 'estados', 'status', 'comandos']:
                handle_status_info(chat_id)
            else:
                if user_id in user_states:
                    handle_text_message(chat_id, user_id, message['text'])
                else:
                    handle_natural_message_fast(chat_id, text)
            
            return "OK", 200
            
        except Exception as e:
            logger.error(f"‚ùå Webhook error: {e}")
            return "ERROR", 500

def handle_natural_message_fast(chat_id, text):
    """Manejar mensajes naturales optimizado"""
    text_lower = text.lower()
    
    if any(word in text_lower for word in ['iniciativa', 'proyecto', 'lista']):
        send_telegram_message(chat_id, "üéØ Ver iniciativas: iniciativas")
    elif any(word in text_lower for word in ['buscar', 'encontrar']):
        send_telegram_message(chat_id, "üîç Buscar: buscar API")
    elif any(word in text_lower for word in ['crear', 'nueva']):
        send_telegram_message(chat_id, "üÜï Crear: crear")
    elif any(word in text_lower for word in ['an√°lisis', 'analizar']):
        send_telegram_message(chat_id, "üìä An√°lisis: analizar")
    elif any(word in text_lower for word in ['sprint', 'desarrollo', 'dev']):
        send_telegram_message(chat_id, "üîß En desarrollo: sprint")
    elif any(word in text_lower for word in ['producci√≥n', 'production', 'implementado']):
        send_telegram_message(chat_id, "üöÄ Implementadas: production")
    elif any(word in text_lower for word in ['estado', 'status', 'comando']):
        send_telegram_message(chat_id, "üìä Estados: estados")
    else:
        send_telegram_message(chat_id, """üëã **Comandos disponibles:**

**üìã B√°sicos:** iniciativas, buscar, crear, analizar
**üìä Estados:** pending, sprint, production, monitoring

üí° **Tip:** Escribe ayuda para ver todos los comandos.""")

def handle_start_command(chat_id):
    """Comando start optimizado"""
    logger.info(f"üì± /start from chat {chat_id}")
    
    text = """üéØ **Bot Saludia v2.6** ‚ö° GESTI√ìN DE ESTADOS

üîπ Asistente de gesti√≥n de iniciativas para equipos Saludia.

**üìã Comandos principales:**
‚Ä¢ iniciativas - Lista ordenada por score RICE
‚Ä¢ buscar Product - B√∫squeda por equipo
‚Ä¢ crear - Nueva iniciativa con RICE
‚Ä¢ analizar - An√°lisis AI del portfolio

**üìä Filtros por Estado:**
‚Ä¢ pending - Iniciativas pendientes
‚Ä¢ sprint - En desarrollo activo
‚Ä¢ production - Implementadas y activas
‚Ä¢ monitoring - En monitoreo
‚Ä¢ cancelled - Canceladas
‚Ä¢ hold - Pausadas temporalmente

**üîç Ejemplos de b√∫squeda:**
‚Ä¢ buscar Product - Por equipo
‚Ä¢ buscar API - Por tecnolog√≠a
‚Ä¢ buscar Juan - Por responsable

**‚ö° Nuevo en v2.6:**
‚Ä¢ Comandos simples sin s√≠mbolos raros
‚Ä¢ Filtros claros por estado
‚Ä¢ API con paginaci√≥n avanzada
‚Ä¢ Cache optimizado

üí° **Tip:** Escribe solo la palabra, sin barras ni comillas."""
    
    send_telegram_message(chat_id, text, parse_mode='Markdown')

def handle_help_command(chat_id):
    """Comando help optimizado"""
    text = """üìö **Comandos Disponibles** ‚ö° v2.5

**üèÉ‚Äç‚ôÇÔ∏è Comandos R√°pidos:**
‚Ä¢ `iniciativas` - Lista completa por score RICE
‚Ä¢ `buscar <t√©rmino>` - B√∫squeda optimizada
‚Ä¢ `crear` - Nueva iniciativa (validaciones RICE)
‚Ä¢ `analizar` - An√°lisis AI estrat√©gico

**üîç B√∫squedas:**
‚Ä¢ `buscar Product` - Por equipo
‚Ä¢ `buscar droger√≠a` - Por descripci√≥n
‚Ä¢ `buscar API` - Por tecnolog√≠a

**üèÜ Score RICE:**
‚Ä¢ üî• Score ‚â• 2.0 (Alta prioridad)
‚Ä¢ ‚≠ê Score ‚â• 1.0 (Media prioridad)
‚Ä¢ üìã Score < 1.0 (Baja prioridad)

**üèóÔ∏è Arquitectura Modular v2.5:**
‚úÖ C√≥digo organizado en m√≥dulos especializados
‚úÖ F√°cil debug y mantenimiento
‚úÖ Performance optimizado
‚úÖ Cache inteligente de 5min

ü§ñ **IA:** An√°lisis estrat√©gico especializado en Saludia con insights priorizados por score RICE."""
    
    send_telegram_message(chat_id, text, parse_mode='Markdown')

def handle_list_initiatives_fast(chat_id):
    """Listar iniciativas optimizado"""
    logger.info(f"üì± List initiatives FAST from chat {chat_id}")
    
    send_telegram_message(chat_id, "‚ö° **Cargando iniciativas...**")
    
    data = get_initiatives()
    
    if not data.get("success"):
        send_telegram_message(chat_id, f"‚ùå Error: {data.get('error', 'Desconocido')}")
        return
    
    initiatives = data.get("data", [])
    
    if not initiatives:
        send_telegram_message(chat_id, "üì≠ No hay iniciativas.")
        return
    
    # Estad√≠sticas r√°pidas
    stats = calculate_statistics_fast(initiatives)
    stats_text = format_statistics_text_fast(stats)
    send_telegram_message(chat_id, stats_text, parse_mode='Markdown')
    
    # Lista r√°pida - solo top 10
    sorted_initiatives = stats.get('sorted_initiatives', initiatives)
    
    text = f"üìã **TOP {MAX_RESULTS_LIST} INICIATIVAS POR SCORE:**\n\n"
    for i, init in enumerate(sorted_initiatives[:MAX_RESULTS_LIST], 1):
        formatted = format_initiative_summary_fast(init, i)
        text += f"{formatted}\n\n"
    
    if len(sorted_initiatives) > MAX_RESULTS_LIST:
        text += f"üìå **{len(sorted_initiatives) - MAX_RESULTS_LIST} iniciativas m√°s...**\nUsa `buscar` para encontrar espec√≠ficas."
    
    cache_info = " (Cache)" if data.get("cached") else " (Fresh)"
    text += f"\nüí° **Tip:** Datos actualizados{cache_info}"
    
    send_telegram_message(chat_id, text, parse_mode='Markdown')

def handle_search_command_fast(chat_id, query):
    """B√∫squeda optimizada"""
    logger.info(f"üì± Search FAST '{query}' from chat {chat_id}")
    
    result = search_initiatives(query)
    
    if not result.get("success"):
        send_telegram_message(chat_id, f"‚ùå Error: {result.get('error')}")
        return
    
    results = result.get("results", [])
    total = result.get("total", 0)
    
    if not results:
        send_telegram_message(chat_id, f"""üîç **Sin resultados:** "{query}"

üí° **Sugerencias:**
‚Ä¢ `buscar Product` - Por equipo
‚Ä¢ `buscar API` - Por tecnolog√≠a
‚Ä¢ `iniciativas` - Ver todas""")
        return
    
    text = f"üîç **RESULTADOS:** {query} ({total} encontrados)\n\n"
    
    # Mostrar solo primeros MAX_RESULTS_SEARCH resultados
    for i, init in enumerate(results[:MAX_RESULTS_SEARCH], 1):
        name = init.get('initiative_name', 'Sin nombre')
        team = init.get('team', 'Sin equipo')
        score = calculate_score_fast(init)
        priority = "üî•" if score >= 2.0 else "‚≠ê" if score >= 1.0 else "üìã"
        
        text += f"**{i}.** {priority} **{name}** (Score: {score:.2f})\n"
        text += f"üë• {team} | üë§ {init.get('owner', 'Sin owner')}\n"
        text += f"üìù {init.get('description', 'Sin descripci√≥n')[:100]}...\n\n"
    
    if total > MAX_RESULTS_SEARCH:
        text += f"üìå **{total - MAX_RESULTS_SEARCH} resultados m√°s...** Refina tu b√∫squeda."
    
    send_telegram_message(chat_id, text, parse_mode='Markdown')

def handle_analyze_command_fast(chat_id):
    """An√°lisis optimizado"""
    logger.info(f"üì± Analyze FAST from chat {chat_id}")
    
    send_telegram_message(chat_id, "ü§ñ **Analizando portfolio...** ‚ö°")
    
    import time
    start_time = time.time()
    data = get_initiatives()
    
    if not data.get("success"):
        send_telegram_message(chat_id, f"‚ùå Error: {data.get('error')}")
        return
    
    initiatives = data.get("data", [])
    
    if not initiatives:
        send_telegram_message(chat_id, "üì≠ No hay iniciativas.")
        return
    
    # Estad√≠sticas r√°pidas primero
    stats = calculate_statistics_fast(initiatives)
    stats_text = format_statistics_text_fast(stats)
    
    cache_info = " (Cache)" if data.get("cached") else " (Fresh)"
    stats_text += f"\n‚ö° **Datos{cache_info}**"
    
    send_telegram_message(chat_id, stats_text, parse_mode='Markdown')
    
    # An√°lisis AI optimizado
    if GROQ_API_KEY:
        send_telegram_message(chat_id, "üß† **Generando an√°lisis estrat√©gico...**")
        
        analysis = analyze_initiatives_with_llm_fast(initiatives)
        analysis_time = time.time() - start_time
        
        analysis_text = f"ü§ñ **AN√ÅLISIS ESTRAT√âGICO** ‚ö°\n\n{analysis}"
        analysis_text += f"\n\n‚è±Ô∏è **Tiempo:** {analysis_time:.1f}s"
        
        if len(analysis_text) > MAX_MESSAGE_LENGTH:
            chunks = [analysis_text[i:i+MAX_MESSAGE_LENGTH] for i in range(0, len(analysis_text), MAX_MESSAGE_LENGTH)]
            for chunk in chunks:
                send_telegram_message(chat_id, chunk, parse_mode='Markdown')
        else:
            send_telegram_message(chat_id, analysis_text, parse_mode='Markdown')
    else:
        send_telegram_message(chat_id, "‚ö†Ô∏è An√°lisis AI no disponible.")

def format_initiative_summary_fast(initiative, index=None):
    """Formatear iniciativa optimizado"""
    try:
        name = initiative.get('initiative_name', 'Sin nombre')
        owner = initiative.get('owner', 'Sin owner')
        team = initiative.get('team', 'Sin equipo')
        score = calculate_score_fast(initiative)
        
        priority_emoji = "üî•" if score >= 2.0 else "‚≠ê" if score >= 1.0 else "üìã"
        prefix = f"**{index}.** " if index else ""
        
        return f"{prefix}{priority_emoji} **{name}** (Score: {score:.2f})\nüë§ {owner} | üë• {team}"
        
    except Exception as e:
        logger.error(f"Format error: {e}")
        return f"{index}. **Error de formato**"

def handle_create_command(chat_id, user_id):
    """Crear iniciativa"""
    logger.info(f"üì± Create command from chat {chat_id}")
    
    user_states[user_id] = {
        'step': 'name',
        'data': {},
        'chat_id': chat_id
    }
    
    text = """üÜï **CREAR INICIATIVA** ‚ö°

üìù **Paso 1/8:** Nombre de la iniciativa

Env√≠a el nombre (m√°ximo 255 caracteres).

**Ejemplos:**
‚Ä¢ "Integraci√≥n API de pagos"
‚Ä¢ "Optimizaci√≥n del checkout"
‚Ä¢ "Dashboard analytics v2"

üí° **Tip:** Nombre descriptivo para mejor score RICE."""
    
    send_telegram_message(chat_id, text, parse_mode='Markdown')

def handle_text_message(chat_id, user_id, text):
    """Manejar mensajes de creaci√≥n - versi√≥n optimizada"""
    if user_id not in user_states:
        return
    
    state = user_states[user_id]
    step = state['step']
    
    try:
        if step == 'name':
            if len(text) > MAX_INITIATIVE_NAME:
                send_telegram_message(chat_id, f"‚ùå M√°ximo {MAX_INITIATIVE_NAME} caracteres.")
                return
            
            state['data']['initiative_name'] = text.strip()
            state['step'] = 'description'
            send_telegram_message(chat_id, f"""üìù **Paso 2/8:** Descripci√≥n

Describe la iniciativa (m√°ximo {MAX_DESCRIPTION} caracteres).

üí° **Tip:** Incluye problema y beneficio esperado.""", parse_mode='Markdown')
        
        elif step == 'description':
            if len(text) > MAX_DESCRIPTION:
                send_telegram_message(chat_id, f"‚ùå M√°ximo {MAX_DESCRIPTION} caracteres.")
                return
                
            state['data']['description'] = text.strip()
            state['step'] = 'owner'
            send_telegram_message(chat_id, f"""üë§ **Paso 3/8:** Responsable

¬øQui√©n es el owner? (m√°ximo {MAX_OWNER_NAME} caracteres)

**Ejemplo:** Juan P√©rez""", parse_mode='Markdown')
        
        elif step == 'owner':
            if len(text) > MAX_OWNER_NAME:
                send_telegram_message(chat_id, f"‚ùå M√°ximo {MAX_OWNER_NAME} caracteres.")
                return
                
            state['data']['owner'] = text.strip()
            state['step'] = 'team'
            send_telegram_message(chat_id, f"""üë• **Paso 4/8:** Equipo

**Opciones:** {', '.join(VALID_TEAMS)}""", parse_mode='Markdown')
        
        elif step == 'team':
            matched_team = next((t for t in VALID_TEAMS if t.lower() == text.strip().lower()), None)
            
            if not matched_team:
                send_telegram_message(chat_id, f"‚ùå Debe ser: {', '.join(VALID_TEAMS)}")
                return
            
            state['data']['team'] = matched_team
            state['step'] = 'portal'
            send_telegram_message(chat_id, f"""üñ•Ô∏è **Paso 5/8:** Portal

**Opciones:** {', '.join(VALID_PORTALS)}""", parse_mode='Markdown')
        
        elif step == 'portal':
            matched_portal = next((p for p in VALID_PORTALS if p.lower() == text.strip().lower()), None)
            
            if not matched_portal:
                send_telegram_message(chat_id, f"‚ùå Debe ser: {', '.join(VALID_PORTALS)}")
                return
            
            state['data']['portal'] = matched_portal
            state['step'] = 'kpi'
            send_telegram_message(chat_id, f"""üìä **Paso 6/8:** KPI Principal (Opcional)

**Ejemplos:** Conversion Rate, GMV, User Retention

üí° Escribe `ninguno` si no tienes KPI espec√≠fico.""", parse_mode='Markdown')
        
        elif step == 'kpi':
            if text.strip().lower() not in ['ninguno', 'no', 'n/a', '']:
                if len(text.strip()) > MAX_KPI_LENGTH:
                    send_telegram_message(chat_id, f"‚ùå M√°ximo {MAX_KPI_LENGTH} caracteres.")
                    return
                state['data']['main_kpi'] = text.strip()
            
            state['step'] = 'reach'
            send_telegram_message(chat_id, """üìà **Paso 7/8:** M√©tricas RICE

**REACH:** ¬øQu√© % de usuarios impacta?
Env√≠a n√∫mero entre 0-100.

**Ejemplos:** 85, 25, 100""", parse_mode='Markdown')
        
        elif step == 'reach':
            try:
                reach = float(text.strip())
                if not (0 <= reach <= 100):
                    send_telegram_message(chat_id, "‚ùå Entre 0 y 100.")
                    return
                
                state['data']['reach'] = reach / 100
                state['step'] = 'impact'
                send_telegram_message(chat_id, """üí• **IMPACT:** ¬øQu√© tanto impacto?

**Opciones:** 1 (bajo), 2 (medio), 3 (alto)""", parse_mode='Markdown')
                
            except ValueError:
                send_telegram_message(chat_id, "‚ùå N√∫mero v√°lido entre 0-100.")
                return
        
        elif step == 'impact':
            try:
                impact = int(text.strip())
                if impact not in [1, 2, 3]:
                    send_telegram_message(chat_id, "‚ùå Debe ser 1, 2 o 3.")
                    return
                
                state['data']['impact'] = impact
                state['step'] = 'confidence'
                send_telegram_message(chat_id, """üéØ **CONFIDENCE:** ¬ø% de confianza en el impacto?

N√∫mero entre 0-100.

**Ejemplos:** 90, 70, 50""", parse_mode='Markdown')
                
            except ValueError:
                send_telegram_message(chat_id, "‚ùå N√∫mero v√°lido: 1, 2 o 3.")
                return
        
        elif step == 'confidence':
            try:
                confidence = float(text.strip())
                if not (0 <= confidence <= 100):
                    send_telegram_message(chat_id, "‚ùå Entre 0 y 100.")
                    return
                
                state['data']['confidence'] = confidence / 100
                state['step'] = 'effort'
                send_telegram_message(chat_id, """‚ö° **EFFORT:** ¬øCu√°ntos sprints de desarrollo?

**Ejemplos:** 1, 2.5, 0.5

üí° Escribe `default` para 1 sprint.""", parse_mode='Markdown')
                
            except ValueError:
                send_telegram_message(chat_id, "‚ùå N√∫mero v√°lido entre 0-100.")
                return
        
        elif step == 'effort':
            if text.strip().lower() in ['default', '']:
                state['data']['effort'] = 1.0
            else:
                try:
                    effort = float(text.strip())
                    if effort <= 0:
                        send_telegram_message(chat_id, "‚ùå Mayor a 0.")
                        return
                    state['data']['effort'] = effort
                except ValueError:
                    send_telegram_message(chat_id, "‚ùå N√∫mero v√°lido o 'default'.")
                    return
            
            # Crear iniciativa
            create_result = create_initiative(state['data'])
            
            if create_result.get('success'):
                data = state['data']
                score = (data['reach'] * data['impact'] * data['confidence']) / data['effort']
                
                priority_emoji = "üî•" if score >= 2.0 else "‚≠ê" if score >= 1.0 else "üìã"
                priority_text = "Alta" if score >= 2.0 else "Media" if score >= 1.0 else "Baja"
                
                confirmation = f"""‚úÖ **INICIATIVA CREADA** ‚ö°

{priority_emoji} **{data['initiative_name']}**

üë§ **Owner:** {data['owner']}
üë• **Equipo:** {data['team']}
üñ•Ô∏è **Portal:** {data['portal']}

üìà **M√©tricas RICE:**
‚Ä¢ **Reach:** {data['reach']*100:.0f}%
‚Ä¢ **Impact:** {data['impact']}/3
‚Ä¢ **Confidence:** {data['confidence']*100:.0f}%
‚Ä¢ **Effort:** {data['effort']} sprints
‚Ä¢ **Score:** {score:.2f}

üèÜ **Prioridad:** {priority_text} ({priority_emoji})

üí° **Siguiente:** `buscar {data['initiative_name'][:20]}`"""
                
                send_telegram_message(chat_id, confirmation, parse_mode='Markdown')
            else:
                error_msg = f"‚ùå Error: {create_result.get('error', 'Desconocido')}"
                if 'validation_errors' in create_result:
                    error_msg += f"\n\n**Errores:**\n‚Ä¢ " + "\n‚Ä¢ ".join(create_result['validation_errors'])
                send_telegram_message(chat_id, error_msg, parse_mode='Markdown')
            
            del user_states[user_id]
    
    except Exception as e:
        logger.error(f"‚ùå Text message error: {e}")
        send_telegram_message(chat_id, "‚ùå Error procesando mensaje.")
        if user_id in user_states:
            del user_states[user_id]
